#!/usr/bin/env bash

echo > test_output

file_list=${@:-$(find chapters -name "test*.go")}

for file in $file_list; do
  expected=${file/.go/.expected}
  escapedoutput=${expected}.escaped
  escapedfile=${file}.escaped

  if [ -f $expected ]; then
    if diff <( go run $file 2>&1) $expected > /dev/null; then
      echo -n .
    else
      echo "Failed: $file" >> test_output
      echo "  To reset, run:" >> test_output
      echo "  rm $expected" >> test_output
      diff -yW200 <( go run $file 2>&1) $expected >> test_output
      echo "------------------------" >> test_output
      echo >> test_output
      echo -n x
    fi
  else
    echo
    echo "$expected not found - generating it..."
    go run $file > $expected
    sed 's/&(?!amp;)/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&#39;/g' < \
      $expected > \
      $escapedoutput
  fi
  sed 's/&(?!amp;)/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&#39;/g' < \
    $file > \
    $escapedfile
done

echo
cat test_output
